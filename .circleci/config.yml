version: 2.1

orbs:
  win: circleci/windows@2.4.0

commands:
  choco_install_cmake:
    steps:
      - run:
          name: install cmake
          command: |
            choco install cmake --installargs 'ADD_CMAKE_TO_PATH=User'
  checkout_with_git_submodule:
    steps:
      - checkout
      - run:
          name: git submodule
          command: |
            git submodule sync --recursive
            git submodule update --progress --init --recursive
  windows_vs2019_devenv_x86_32_build:
    parameters:
      cmake_build_type:
        type: string
        # Debug Release RelWithDebInfo MinSizeRel
        default: Release
    steps:
      - run:
          name: windows vs2019 devenv x86_32 << parameters.cmake_build_type >> build
          command: |
            mkdir build
            pushd build
            cmake -G "Visual Studio 16" -T v142 -A Win32 ..
            if ($LastExitCode -ne 0) { $host.SetShouldExit($LastExitCode) }
            cmake --build . --target install --config "<< parameters.cmake_build_type >>" --clean-first
            if ($LastExitCode -ne 0) { $host.SetShouldExit($LastExitCode) }
            popd
  windows_vs2019_devenv_x86_64_build:
    parameters:
      cmake_build_type:
        type: string
        # Debug Release RelWithDebInfo MinSizeRel
        default: Release
    steps:
      - run:
          name: windows vs2019 devenv x86_64 << parameters.cmake_build_type >> build
          command: |
            mkdir build
            pushd build
            cmake -G "Visual Studio 16" -T v142 -A x64 ..
            if ($LastExitCode -ne 0) { $host.SetShouldExit($LastExitCode) }
            cmake --build . --target install --config "<< parameters.cmake_build_type >>" --clean-first
            if ($LastExitCode -ne 0) { $host.SetShouldExit($LastExitCode) }
            popd
  windows_vs2019_nmake_x86_32_build:
    parameters:
      cmake_build_type:
        type: string
        # Debug Release RelWithDebInfo MinSizeRel
        default: Release
    steps:
      - run:
          name: windows vs2019 nmake x86_32 << parameters.cmake_build_type >> build
          #shell: cmd.exe
          command: |
            pushd HKLM:\SOFTWARE\WOW6432Node\Microsoft
            ls VisualStudio_* |
            foreach { echo $_.Name }
            popd
            cmd.exe
            .cicommon\vs2019_command_prompt.bat x86
            mkdir build
            pushd build
            cmake -DCMAKE_BUILD_TYPE=<< parameters.cmake_build_type >> -G "NMake Makefiles" ..
            popd
  windows_vs2019_nmake_x86_64_build:
    parameters:
      cmake_build_type:
        type: string
        # Debug Release RelWithDebInfo MinSizeRel
        default: Release
    steps:
      - run:
          name: windows vs2019 nmake x86_64 << parameters.cmake_build_type >> build
          shell: cmd.exe
          command:
            .cicommon\vs2019_command_prompt.bat amd64 &&
            .cicommon\cmake_nmake_build.bat "<< parameters.cmake_build_type >>"

jobs:
  windows_vs2019_devenv_x86_32_Release:
    executor: win/default
    steps:
      - choco_install_cmake
      - checkout_with_git_submodule
      - windows_vs2019_devenv_x86_32_build:
          cmake_build_type: Release
  windows_vs2019_devenv_x86_32_Debug:
    executor: win/default
    steps:
      - choco_install_cmake
      - checkout_with_git_submodule
      - windows_vs2019_devenv_x86_32_build:
          cmake_build_type: Debug
  windows_vs2019_devenv_x86_32_RelWithDebInfo:
    executor: win/default
    steps:
      - choco_install_cmake
      - checkout_with_git_submodule
      - windows_vs2019_devenv_x86_32_build:
          cmake_build_type: RelWithDebInfo
  windows_vs2019_devenv_x86_32_MinSizeRel:
    executor: win/default
    steps:
      - choco_install_cmake
      - checkout_with_git_submodule
      - windows_vs2019_devenv_x86_32_build:
          cmake_build_type: MinSizeRel
  windows_vs2019_devenv_x86_64_Release:
    executor: win/default
    steps:
      - choco_install_cmake
      - checkout_with_git_submodule
      - windows_vs2019_devenv_x86_64_build:
          cmake_build_type: Release
  windows_vs2019_devenv_x86_64_Debug:
    executor: win/default
    steps:
      - choco_install_cmake
      - checkout_with_git_submodule
      - windows_vs2019_devenv_x86_64_build:
          cmake_build_type: Debug
  windows_vs2019_devenv_x86_64_RelWithDebInfo:
    executor: win/default
    steps:
      - choco_install_cmake
      - checkout_with_git_submodule
      - windows_vs2019_devenv_x86_64_build:
          cmake_build_type: RelWithDebInfo
  windows_vs2019_devenv_x86_64_MinSizeRel:
    executor: win/default
    steps:
      - choco_install_cmake
      - checkout_with_git_submodule
      - windows_vs2019_devenv_x86_64_build:
          cmake_build_type: MinSizeRel
  windows_vs2019_nmake_x86_32_Release:
    executor: win/default
    steps:
      - choco_install_cmake
      - checkout_with_git_submodule
      - windows_vs2019_nmake_x86_32_build:
          cmake_build_type: Release
  windows_vs2019_nmake_x86_32_Debug:
    executor: win/default
    steps:
      - choco_install_cmake
      - checkout_with_git_submodule
      - windows_vs2019_nmake_x86_32_build:
          cmake_build_type: Debug with white space
  windows_vs2019_nmake_x86_32_RelWithDebInfo:
    executor: win/default
    steps:
      - choco_install_cmake
      - checkout_with_git_submodule
      - windows_vs2019_nmake_x86_32_build:
          cmake_build_type: RelWithDebInfo
  windows_vs2019_nmake_x86_32_MinSizeRel:
    executor: win/default
    steps:
      - choco_install_cmake
      - checkout_with_git_submodule
      - windows_vs2019_nmake_x86_32_build:
          cmake_build_type: MinSizeRel
  windows_vs2019_nmake_x86_64_Release:
    executor: win/default
    steps:
      - choco_install_cmake
      - checkout_with_git_submodule
      - windows_vs2019_nmake_x86_64_build:
          cmake_build_type: Release
  windows_vs2019_nmake_x86_64_Debug:
    executor: win/default
    steps:
      - choco_install_cmake
      - checkout_with_git_submodule
      - windows_vs2019_nmake_x86_64_build:
          cmake_build_type: Debug
  windows_vs2019_nmake_x86_64_RelWithDebInfo:
    executor: win/default
    steps:
      - choco_install_cmake
      - checkout_with_git_submodule
      - windows_vs2019_nmake_x86_64_build:
          cmake_build_type: RelWithDebInfo
  windows_vs2019_nmake_x86_64_MinSizeRel:
    executor: win/default
    steps:
      - choco_install_cmake
      - checkout_with_git_submodule
      - windows_vs2019_nmake_x86_64_build:
          cmake_build_type: MinSizeRel

workflows:
  version: 2
  build:
    jobs:
      #- windows_vs2019_devenv_x86_32_Release
      #- windows_vs2019_devenv_x86_32_Debug
      #- windows_vs2019_devenv_x86_32_RelWithDebInfo
      #- windows_vs2019_devenv_x86_32_MinSizeRel
      #- windows_vs2019_devenv_x86_64_Release
      #- windows_vs2019_devenv_x86_64_Debug
      #- windows_vs2019_devenv_x86_64_RelWithDebInfo
      #- windows_vs2019_devenv_x86_64_MinSizeRel
      #- windows_vs2019_nmake_x86_32_Release
      - windows_vs2019_nmake_x86_32_Debug
      #- windows_vs2019_nmake_x86_32_RelWithDebInfo
      #- windows_vs2019_nmake_x86_32_MinSizeRel
      #- windows_vs2019_nmake_x86_64_Release
      #- windows_vs2019_nmake_x86_64_Debug
      #- windows_vs2019_nmake_x86_64_RelWithDebInfo
      #- windows_vs2019_nmake_x86_64_MinSizeRel
